$(document).ready(function(){function m(){var o,n,p;o=$("#extraform").outerHeight(true);n=$(".extralist").outerHeight(true);if(o>n){p=o}else{p=n}$("#addform").css("height",p+130+"px");$("#sidebar").height($("#main").outerHeight(true))}function e(){$(".delete").off("click").off("mouseover");$(".moveup").off("click").off("mouseover");$(".movedown").off("click").off("mouseover");$(".delete").on("click",function(){var n;n=$(this).parent();n.remove()}).on("mouseover",function(){$(this).tooltip("show")});$(".moveup").on("click",function(){var n;n=$(this).parent();n.insertBefore(n.prev())}).on("mouseover",function(){$(this).tooltip("show")});$(".movedown").on("click",function(){var n;n=$(this).parent();n.insertAfter(n.next())}).on("mouseover",function(){$(this).tooltip("show")})}function j(p){for(var n=0;n<$("#extraform").children().length;n++){if($("#extraform").find("label")[n].textContent===p){alert("已经包含项目【"+p+"】，请勿重复添加。");return false}}return true}m();e();$('.target .extralist h4:not(:contains("自定义"))').click(function(o){if(j(o.target.textContent)){var n='<div style="display: inline" class="form-group"><label class="baomingitem">'+o.target.textContent+'</label>&emsp;&emsp;&emsp;&emsp;&ensp;<a class="moveup" data-toggle="tooltip" data-placement="bottom" title="向上移动"><span class="glyphicon glyphicon-arrow-up"></span></a>&ensp;<a class="movedown" data-toggle="tooltip" data-placement="bottom" title="向下移动"><span class="glyphicon glyphicon-arrow-down"></span></a>&ensp;<a class="delete" data-toggle="tooltip" data-placement="right" title="删除项目"><span class="glyphicon glyphicon-trash"></span></a><hr></div>';$("#extraform").append(n);m();e()}});$("#zidingyishort2,#zidingyilong2").click(function(o){var n='<div style="display: inline" class="form-group"><label class="baomingitem">'+o.target.textContent+'</label>&ensp;<input type="text" placeholder="请输入问题描述">&emsp;&emsp;&emsp;&emsp;<a class="moveup" data-toggle="tooltip" data-placement="bottom" title="向上移动"><span class="glyphicon glyphicon-arrow-up"></span></a>&ensp;<a class="movedown" data-toggle="tooltip" data-placement="bottom" title="向下移动"><span class="glyphicon glyphicon-arrow-down"></span></a>&ensp;<a class="delete" data-toggle="tooltip" data-placement="right" title="删除项目"><span class="glyphicon glyphicon-trash"></span></a><hr></div>';$("#extraform").append(n);m();e()});$(".theme").mouseover(function(){$(this).prop("src",$(this).prop("src").toString().replace("0.png","1.png"))}).mouseout(function(){$(this).prop("src",$(this).prop("src").toString().replace("1.png","0.png"))});var l=function(o){var n="";switch(o){case 101:n="学号";break;case 102:n="姓名";break;case 103:n="性别";break;case 104:n="学院";break;case 105:n="专业";break;case 106:n="特长";break;case 107:n="电子邮箱";break;case 108:n="QQ";break;case 109:n="手机长号";break;case 110:n="移动短号";break;case 111:n="籍贯";break;case 112:n="第一志愿部门";break;case 113:n="第二志愿部门";break;case 114:n="第三志愿部门";break;case 115:n="是否服从调剂";break;case 1:n="自定义短问题";break;case 2:n="自定义长问题";break;default:n="";break}return n};function d(n){document.getElementById("starttime").value=n.start_time.replace(/\:00$/,"");document.getElementById("stoptime").value=n.stop_time.replace(/\:00$/,"");document.getElementById("regname").value=n.name;var r=document.getElementsByName("grade");var t=n.limit_grade.split("");for(var p=0;p<r.length;p++){if(t[p]==="1"){r[r.length-1-p].checked=true}else{r[r.length-1-p].checked=false}}document.getElementsByName("theme")[n.theme].checked=true;for(var o=0;o<n.questions.length;o++){var s=n.questions[o];if(s.type===101||s.type===102){}else{if(s.type===1||s.type===2){var u="";if(s.type===1){u="自定义短问题"}else{u="自定义长问题"}var q='<div style="display: inline" class="form-group"><label class="baomingitem">'+u+'</label>&ensp;<input type="text" placeholder="请输入问题描述" value="'+s.label+'">&emsp;&emsp;&emsp;&emsp;<a class="moveup" data-toggle="tooltip" data-placement="bottom" title="向上移动"><span class="glyphicon glyphicon-arrow-up"></span></a>&ensp;<a class="movedown" data-toggle="tooltip" data-placement="bottom" title="向下移动"><span class="glyphicon glyphicon-arrow-down"></span></a>&ensp;<a class="delete" data-toggle="tooltip" data-placement="right" title="删除项目"><span class="glyphicon glyphicon-trash"></span></a><hr></div>';$("#extraform").append(q);m();e()}else{var q='<div style="display: inline" class="form-group"><label class="baomingitem">'+l(s.type)+'</label>&emsp;&emsp;&emsp;&emsp;&ensp;<a class="moveup" data-toggle="tooltip" data-placement="bottom" title="向上移动"><span class="glyphicon glyphicon-arrow-up"></span></a>&ensp;<a class="movedown" data-toggle="tooltip" data-placement="bottom" title="向下移动"><span class="glyphicon glyphicon-arrow-down"></span></a>&ensp;<a class="delete" data-toggle="tooltip" data-placement="right" title="删除项目"><span class="glyphicon glyphicon-trash"></span></a><hr></div>';$("#extraform").append(q);m();e()}}}}var c;$.ajax({async:false,type:"get",dataType:"json",url:"/registration/activityinfo?activityId="+_activityId.toString(),success:function(n){if(c===undefined){c=n;d(c)}},error:function(){alert("当前网络不佳，暂时无法加载报名表信息")}});var i;var b=c.start_time.split(/[\s:-]/);i=new Date(parseInt(b[0]),parseInt(b[1])-1,parseInt(b[2]),parseInt(b[3]),parseInt(b[4]),0)>new Date();if(i){$("#starttime").css("cursor","pointer");$("#stoptime").css("cursor","pointer")}else{var a=document.getElementsByClassName("datetimepicker")[0];a.parentNode.removeChild(a);var g=document.getElementById("starttime").parentNode.lastElementChild;g.parentNode.removeChild(g);var f=document.getElementById("starttime").parentNode.lastElementChild;f.parentNode.removeChild(f);document.getElementById("starttime").parentNode.removeAttribute("class");document.getElementById("starttime").parentNode.removeAttribute("data-date");document.getElementById("starttime").parentNode.removeAttribute("data-link-field");$("#starttime").prop("disabled",true);var k=document.createElement("iframe");k.setAttribute("style","border-width:0px;height:100%;width:100%;z-index:99;background-color:rgba(0,0,0,0);position:absolute;top:0;left:0;");var h=document.createElement("iframe");h.setAttribute("style","border-width:0px;height:100%;width:100%;z-index:99;background-color:rgba(0,0,0,0);position:absolute;top:0;left:0");document.getElementById("extraform").appendChild(k);document.getElementsByClassName("extralist")[0].appendChild(h);$("iframe").contents().find("body").css("cursor","not-allowed");$("#starttime").css("cursor","not-allowed");$("#stoptime").css("cursor","pointer")}});$(document).ready(function(){var b=function(c){var d=0;switch(c){case"学号":d=101;break;case"姓名":d=102;break;case"性别":d=103;break;case"学院":d=104;break;case"专业":d=105;break;case"特长":d=106;break;case"电子邮箱":d=107;break;case"QQ":d=108;break;case"手机长号":d=109;break;case"移动短号":d=110;break;case"籍贯":d=111;break;case"第一志愿部门":d=112;break;case"第二志愿部门":d=113;break;case"第三志愿部门":d=114;break;case"是否服从调剂":d=115;break;case"自定义短问题":d=1;break;case"自定义长问题":d=2;break;default:d=0;break}return d};var a=function(){var c=$("#extraform").children().children("label.baomingitem");var h=[false,false,false];var g=[4,4,4,4];var f=0;for(var e=0;e<c.length;e++){if(c[e].textContent==="第一志愿部门"){h[0]=true;g[f]=1;f++}else{if(c[e].textContent==="第二志愿部门"){h[1]=true;g[f]=2;f++}else{if(c[e].textContent==="第三志愿部门"){h[2]=true;g[f]=3;f++}}}}for(var d=0;d<c.length;d++){if(g[d]>g[d+1]){return false}}if(h[2]){return h[0]&&h[1]}else{if(h[1]){return h[0]}else{return true}}};$("#submit").click(function(){var g=true;var E=function(j,i){return j<i};var p={start_time:"",stop_time:"",limit_grade:"",name:"",theme:"",url:"",questions:[]};var h=$("#regname").val();if(h===""){alert("这么好的一张报名表你怎么能不起个响亮的标题呢？");g=false}else{p.name=h}var c=$("#starttime").val();var C=$("#stoptime").val();if(c===""){alert("亲，选个报名开始的时间呗~");g=false}else{if(C===""){alert("怎么说也得有个结束的时间吧~");g=false}else{var n=c.split(/[\s:-]/);var x=C.split(/[\s:-]/);var w=new Date(parseInt(n[0]),parseInt(n[1])-1,parseInt(n[2]),parseInt(n[3]),parseInt(n[4]),0);var v=new Date(parseInt(x[0]),parseInt(x[1])-1,parseInt(x[2]),parseInt(x[3]),parseInt(x[4]),0);var s=E(new Date(2014,8,4,0,0,0),w);var q=E(w,v);if(q&&s){p.start_time=w.getFullYear()+"-"+(w.getMonth()+1)+"-"+w.getDate()+" "+w.getHours()+":"+w.getMinutes()+":"+w.getSeconds();p.stop_time=v.getFullYear()+"-"+(v.getMonth()+1)+"-"+v.getDate()+" "+v.getHours()+":"+v.getMinutes()+":"+v.getSeconds()}else{if(!s){alert("选择的开始时间太早了哦");g=false}else{if(!q){alert("结束时间怎么能比开始时间早呢");g=false}}}if(E(w,new Date())){var t=confirm("温馨提示：如果选择开始时间早于当前时间，默认报名即刻开始，那么“开始时间”和“表格项目”将不能修改。点击【确定】继续提交，点击【取消】暂停提交。");if(t===true){}else{g=false}}}}var e=document.getElementsByName("grade");var o="";for(var A=e.length-1;A>=0;A--){if(e[A].checked===true){o+="1"}else{o+="0"}}if(o==="00000"){alert("请选择允许参加这次报名的年级哦~");g=false}else{p.limit_grade=o}var l=document.getElementsByName("theme");var m="";for(var y=0;y<l.length;y++){if(l[y].checked===true){m=l[y].value}}if(m===""){alert("给你的报名表选择一个漂亮的样式吧！");g=false}else{p.theme=m}if(a()){}else{alert("亲，看起来你的志愿部门排列顺序有点问题啊喂~");g=false}if(g){var B=document.getElementsByClassName("baomingitem");var d;$.ajax({async:false,type:"get",url:"/organization/department",success:function(i){d=i},error:function(){alert("当前网络不佳，暂时无法获得部门信息")}});for(var z=0;z<B.length;z++){var u={question_id:"",type:"",label:"",content:""};u.question_id=z+1;var D=b(B[z].textContent);u.type=D;if(D===1||D===2||D===3){u.label=B[z].parentNode.childNodes[2].value;u.content=""}else{if(D===112||D===113||D===114){u.label=B[z].textContent;u.content=JSON.stringify(d)}else{u.label=B[z].textContent;u.content=""}}p.questions[z]=u}var f={activityId:_activityId,activityInfo:JSON.stringify(p)};$("#preview").prop("disabled",true);$("#submit").prop("disabled",true);$.ajax({type:"POST",url:"/registration/updateactivity",data:f,dataType:"json",success:function(i){if(i.status==="success"){alert(i.content);window.location.href="/admin/register/viewreg"}else{if(i.status==="fail"){alert(i.content);$("#preview").prop("disabled",false);$("#submit").prop("disabled",false)}}},error:function(k,i,j){if(i==="timeout"){alert("连接超时，请检查网络");$("#preview").prop("disabled",false);$("#submit").prop("disabled",false)}else{if(i==="error"||i==="parseerror"){alert("提交失败："+i+" "+j.toString());$("#preview").prop("disabled",false);$("#submit").prop("disabled",false)}}}})}})});